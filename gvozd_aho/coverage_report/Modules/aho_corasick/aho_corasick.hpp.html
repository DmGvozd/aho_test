<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>aho_corasick.hpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#pragma once

#include &lt;vector&gt;
#include &lt;queue&gt;
#include &lt;string&gt;
#include &lt;map&gt;
#include &lt;memory&gt;

class AhoCorasick {
private:
    struct Node {
        std::map&lt;char, std::shared_ptr&lt;Node&gt;&gt; children;
        std::shared_ptr&lt;Node&gt; suffix_link;
        std::shared_ptr&lt;Node&gt; output_link;
        bool is_terminal;
        std::string pattern;

<span style = "background-color:#dfd">        Node() : suffix_link(nullptr), output_link(nullptr), is_terminal(false) {}</span>
    };

    std::shared_ptr&lt;Node&gt; root;

<span style = "background-color:#dfd">    void build_suffix_links() {
        std::queue&lt;std::shared_ptr&lt;Node&gt;&gt; q;</span>

<span style = "background-color:#dfd">        for (auto&amp; p : root-&gt;children) {
            p.second-&gt;suffix_link = root;
            q.push(p.second);
        }</span>

<span style = "background-color:#dfd">        while (!q.empty()) {
            auto current = q.front();
            q.pop();</span>

<span style = "background-color:#dfd">            for (auto&amp; p : current-&gt;children) {
                char ch = p.first;
                auto child = p.second;</span>

<span style = "background-color:#dfd">                auto current_suffix = current-&gt;suffix_link;
                while (current_suffix &amp;&amp; !current_suffix-&gt;children.count(ch)) {
                    current_suffix = current_suffix-&gt;suffix_link;
                }</span>

<span style = "background-color:#dfd">                child-&gt;suffix_link = current_suffix ?</span>
                    current_suffix-&gt;children[ch] : root;

<span style = "background-color:#dfd">                child-&gt;output_link = child-&gt;suffix_link-&gt;is_terminal ?</span>
                    child-&gt;suffix_link : child-&gt;suffix_link-&gt;output_link;

<span style = "background-color:#dfd">                q.push(child);
            }
        }
    }</span>

public:
<span style = "background-color:#dfd">    AhoCorasick() : root(std::make_shared&lt;Node&gt;()) {}</span>

<span style = "background-color:#dfd">    void add_pattern(const std::string&amp; pattern) {
        auto current = root;</span>

<span style = "background-color:#dfd">        for (char ch : pattern) {
            if (!current-&gt;children.count(ch)) {
                current-&gt;children[ch] = std::make_shared&lt;Node&gt;();</span>
            }
<span style = "background-color:#dfd">            current = current-&gt;children[ch];
        }</span>

<span style = "background-color:#dfd">        current-&gt;is_terminal = true;
        current-&gt;pattern = pattern;
    }</span>

<span style = "background-color:#dfd">    void build() {
        build_suffix_links();
    }</span>

<span style = "background-color:#dfd">    std::vector&lt;std::pair&lt;int, std::string&gt;&gt; search(const std::string&amp; text) {
        std::vector&lt;std::pair&lt;int, std::string&gt;&gt; results;
        auto current = root;</span>

<span style = "background-color:#dfd">        for (int i = 0; i &lt; text.length(); ++i) {
            char ch = text[i];</span>

<span style = "background-color:#dfd">            while (current != root &amp;&amp; !current-&gt;children.count(ch)) {
                current = current-&gt;suffix_link;
            }</span>

<span style = "background-color:#dfd">            if (current-&gt;children.count(ch)) {
                current = current-&gt;children[ch];</span>

<span style = "background-color:#dfd">                if (current-&gt;is_terminal) {
                    results.emplace_back(i - current-&gt;pattern.length() + 1,</span>
                        current-&gt;pattern);
                }

<span style = "background-color:#dfd">                auto output = current-&gt;output_link;
                while (output) {
                    results.emplace_back(i - output-&gt;pattern.length() + 1,</span>
                        output-&gt;pattern);
<span style = "background-color:#dfd">                    output = output-&gt;output_link;
                }
            }
        }</span>

<span style = "background-color:#dfd">        return results;
    }</span>
};</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>